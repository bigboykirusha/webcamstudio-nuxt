<template>
  <header>
    <h1 class="InteriorTitle">
      –° –ß–ï–ì–û
      <span class="InteriorTitleSpan">–ù–ê–ß–ò–ù–ê–ï–¢–°–Ø –í–ï–ë–ö–ê–ú</span>
    </h1>
    <nav class="InteriorTitleNav selectNone">
      <nuxt-link class="noDecorationLink" to="/">–ì–ª–∞–≤–Ω–∞—è</nuxt-link>
      <span class="InteriorTitleNavSpan">&gt</span>
      <nuxt-link class="noDecorationLink" to="/articles">–ë–ª–æ–≥</nuxt-link>
      <span class="InteriorTitleNavSpan">&gt</span>
      <span class="noDecorationLink pointer">–° —á–µ–≥–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤–µ–±–∫–∞–º</span>
    </nav>
    <div class="ArticleImage">
      <img class="ArticleImg" src="/src/assets/images/BlogPhoto4Full.webp" />
    </div>
  </header>

  <main>
    <section class="InteriorText">
      <div class="InteriorTextPadding">
        <p class="">
          –°–µ–≥–æ–¥–Ω—è –ø–æ–≥–æ–≤–æ—Ä–∏–º –æ —Ç–æ–º, —á—Ç–æ –∂–µ –Ω—É–∂–Ω–æ –¥–ª—è —É—Å–ø–µ—à–Ω–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞ —Ç–≤–æ–µ–π
          –∫–∞—Ä—å–µ—Ä—ã –æ–Ω–ª–∞–π–Ω –º–æ–¥–µ–ª–∏.
        </p>
        <p class="">
          –ö–æ–Ω–µ—á–Ω–æ, –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≥–æ–¥—ã —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –Ω–∞—Å—Ç–æ–ª—å–∫–æ —à–∞–≥–Ω—É–ª–∏ –≤–ø–µ—Ä—ë–¥, —á—Ç–æ –¥–ª—è
          –∑–∞–ø—É—Å–∫–∞ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ —Ç–µ–±–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞ —Å –º–æ–±–∏–ª—å–Ω—ã–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º,
          –Ω–æ –≤ —É—Å–ª–æ–≤–∏—è—Ö —Ä–∞—Å—Ç—É—â–µ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ —ç—Ç–æ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å —Ç–≤–æ–µ–π –ø–µ—Ä–≤–æ–π –∏
          —Ñ–∞—Ç–∞–ª—å–Ω–æ–π –æ—à–∏–±–∫–æ–π –Ω–∞ –ø—É—Ç–∏ –∫ –±–æ–ª—å—à–æ–º—É –∑–∞—Ä–∞–±–æ—Ç–∫—É. –ü–æ–º–Ω–∏—à—å, –≤—Å—Ç—Ä–µ—á–∞—é—Ç –ø–æ
          –æ–¥—ë–∂–∫–µ, –ø—Ä–æ–≤–æ–∂–∞—é—Ç –ø–æ —É–º—É? –¢–∞–∫ –≤–æ—Ç, –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å —Ç–≤–æ—è –∫–∞—Ä—Ç–∏–Ω–∫–∞
          –¥–æ–ª–∂–Ω–∞ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç—å –∑—Ä–∏—Ç–µ–ª—è.
        </p>
        <p class="">
          –°–≤–µ—Çüí°, –∫–∞–º–µ—Ä–∞üì∏, –∏–Ω—Ç–µ—Ä–Ω–µ—Çüåê. –¢—Ä–∏ –∫–∏—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö —Å—Ç–æ–∏—Ç —Ç–≤–æ–π —É—Å–ø–µ—Ö.
        </p>
        <p class="">
          –°–≤–µ—Ç –ª—É—á—à–µ –≤—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞—Å—Å–µ—è–Ω–Ω—ã–π, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π (–ø–æ–¥–æ–π–¥—É—Ç
          —Å–æ—Ñ—Ç–±–æ–∫—Å—ã –∏–ª–∏ –∫–æ–ª—å—Ü–µ–≤–∞—è –ª–∞–º–ø–∞). –û–Ω —Å–≥–ª–∞–¥–∏—Ç –Ω–µ—Ä–æ–≤–Ω–æ—Å—Ç–∏ –∫–æ–∂–∏, —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ
          –æ—Å–≤–µ—Ç–∏–≤ –≤—Å–µ –ª–∏—Ü–æ, —Ç–∞–∫–∂–µ –¥–∞—Å—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π –¥–ª—è
          –≥–ª–∞–∑–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ä–µ–∂–∏–º.
        </p>
        <p class="">
          –í–µ–±-–∫–∞–º–µ—Ä—É —Å—Ç–æ–∏—Ç –ø—Ä–∏–æ–±—Ä–µ—Ç–∞—Ç—å —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º –Ω–µ –º–µ–Ω—å—à–µ 720, –∞ –≤ –∏–¥–µ–∞–ª–µ
          1080, –Ω–∏–∫—Ç–æ –∂–µ –Ω–µ —Å–º–æ—Ç—Ä–∏—Ç –ª—é–±–∏–º—ã–µ —Å–µ—Ä–∏–∞–ª—ã –≤ 480??? –¢–∞–∫–∂–µ, —Å–∞–º–∏ —Å–∞–π—Ç—ã
          –∞–∫—Ç–∏–≤–Ω–µ–µ –ø—Ä–æ–¥–≤–∏–≥–∞—é—Ç –º–æ–¥–µ–ª–µ–π —Å —Ö–æ—Ä–æ—à–∏–º –∫–∞—á–µ—Å—Ç–≤–æ–º —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏.
        </p>
        <p class="">
          –°–∫–æ—Ä–æ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–≤–∞–µ—Ç –º–Ω–æ–≥–æ! –í—ã–±—Ä–∞–≤ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ç–∞—Ä–∏—Ñ —É
          —Å–≤–æ–µ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞, —Ç—ã —Ä–∏—Å–∫—É–µ—à—å –ø–æ—Ç–µ—Ä—è—Ç—å –∑—Ä–∏—Ç–µ–ª–µ–π –∏–∑-–∑–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö
          –∑–∞–¥–µ—Ä–∂–µ–∫ –∏ –æ–±—Ä—ã–≤–æ–≤ —Å—Ç—Ä–∏–º–∞, —Ç–∞–∫ —á—Ç–æ –Ω–∞ —ç—Ç–æ–º –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å—Ç–æ–∏—Ç —ç–∫–æ–Ω–æ–º–∏—Ç—å.
        </p>
        <p class="">
          –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ —É —Ç–µ–±—è –≤—Å–µ–≥–æ —ç—Ç–æ–≥–æ –Ω–µ—Ç, —Ä–∞–≤–Ω–æ –∫–∞–∫ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
          –≤–ª–æ–∂–∏—Ç—å –±–æ–ª—å—à–∏–µ –¥–µ–Ω—å–≥–∏ –≤ —Å–≤–æ–π —Å—Ç–∞—Ä—Ç? –ü—Ä–∏—Ö–æ–¥–∏ –≤ –Ω–∞—à—É —Å—Ç—É–¥–∏—é, –≤–µ–¥—å —Ç—É—Ç
          —Ç—ã —Å–º–æ–∂–µ—à—å —Å—Ç—Ä–∏–º–∏—Ç—å –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–∞–π—Ç–æ–≤ –≤ 4–∫ –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫, –∞ –æ–ø—ã—Ç–Ω—ã–µ
          –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –≥–æ—Ç–æ–≤—ã –≤ –ª—é–±—É—é –º–∏–Ω—É—Ç—É –ø–æ–º–æ—á—å —Ç–µ–±–µ —Å –ª—é–±—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏.
        </p>
      </div>
    </section>
    <section class="ArticleShareBlock">
      <div class="ArticleShareBlockPadding">
        <div class="ArticleShareBlockPaddingLeft">
          <span
            class="ArticleShareBlockText"
            :class="{ collapsed: isSharedPressed }"
            @click="pressShare()"
            >–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span
          >
          <div
            class="ArticleShareBlockIcons"
            :class="{ collapsed: isSharedPressed }"
          >
            <a :href="shareUrlVK" target="_blank" class="social-button vk"
              ><ShareVkIcon class="pointer"></ShareVkIcon
            ></a>
            <a :href="shareUrlOK" target="_blank" class="social-button ok"
              ><ShareOkIcon class="pointer"></ShareOkIcon
            ></a>
            <a
              :href="shareUrlTwitter"
              target="_blank"
              class="social-button twitter"
              ><ShareXtwitterIcon class="pointer"></ShareXtwitterIcon
            ></a>
            <a
              :href="shareUrlPinterest"
              target="_blank"
              class="social-button pinterest"
              ><SharePinterestIcon class="pointer"></SharePinterestIcon
            ></a>
            <a
              :href="shareUrlLinkedIn"
              target="_blank"
              class="social-button linkedin"
              ><ShareLinkedinIcon class="pointer"></ShareLinkedinIcon
            ></a>
          </div>
        </div>
        <div class="ArticleShareBlockPaddingRight">
          <span class="ArticleLikesCount">{{
            postLikesCount ? `+${postLikesCount}` : `0`
          }}</span>

          <UpvoteActivated
            v-if="isLiked()"
            class="pointer"
            @click="dislikePostDB()"
          ></UpvoteActivated>
          <UpvoteDeactivated
            v-else
            class="pointer"
            @click="likePostDB()"
          ></UpvoteDeactivated>
        </div>
      </div>
    </section>
  </main>

  <footer class="line-15">
    <FooterTopLine class="FooterTopLine" />
    <div class="FooterGrid">
      <button
        class="PrivacyPolicyLink font9 pointer"
        @click="goToPrivacyPolicy()"
      >
        –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
      </button>
      <ArrowCircleUp class="FooterGridArrowUp" @click="scrollToTop()" />
      <p class="Trademark font9">¬© kinky studio. 2019-2024 –≥–æ–¥.</p>
    </div>
  </footer>
  <hr class="FinalLine" />
</template>
<script setup>
import ArrowCircleUp from "@/assets/icons/ArrowCircleUp.vue";
import FooterTopLine from "@/assets/icons/FooterTopLine.vue";
import ShareLinkedinIcon from "@/assets/icons/ShareLinkedinIcon.vue";
import ShareOkIcon from "@/assets/icons/ShareOkIcon.vue";
import SharePinterestIcon from "@/assets/icons/SharePinterestIcon.vue";
import ShareVkIcon from "@/assets/icons/ShareVkIcon.vue";
import ShareXtwitterIcon from "@/assets/icons/ShareXtwitterIcon.vue";
import UpvoteDeactivated from "@/assets/icons/UpvoteDeactivated.vue";
import UpvoteActivated from "@/assets/icons/UpvoteActivated.vue";

import { useRouter } from "vue-router";
import posts from "@/src/assets/posts.json";

onMounted(() => {
  loadLikedPosts();
  loadLikesCount();
  prepareSharing();
});

// DATA

const postId = "4";
const postLikesCount = ref(0);

// Misc methods start

function scrollToTop() {
  window.scrollTo({
    top: 0,
    behavior: "auto",
  });
}

function goToPrivacyPolicy() {
  window.open("/privacy-policy", "_blank", "noopener,noreferrer");
}

const isSharedPressed = ref(true);
function pressShare() {
  isSharedPressed.value = true;
}

// Misc methods end

// Blog posts likes start

const likedPostsIds = ref([]);
function loadLikedPosts() {
  likedPostsIds.value = JSON.parse(localStorage.getItem("likedPosts") || "[]");
}

function isLiked() {
  return likedPostsIds.value.includes(postId);
}

async function loadLikesCount() {
  try {
    // Attempt to fetch the number of likes for the given postId
    const { data, error } = await supabase
      .from("blogpostslikes")
      .select("likes")
      .eq("post_id", postId)
      .single();

    if (error) {
      throw error;
    }
    if (data) {
      postLikesCount.value = data.likes;
    } else {
      postLikesCount.value = 0;
    }
  } catch (error) {
    console.error("Error fetching likes:", error.message);
    return null;
  }
}

function toggleLike() {
  const index = likedPostsIds.value.indexOf(postId);
  if (index === -1) {
    likedPostsIds.value.push(postId);
  } else {
    likedPostsIds.value.splice(index, 1);
  }
  if (typeof window !== "undefined") {
    localStorage.setItem("likedPosts", JSON.stringify(likedPostsIds.value));
  }
}

// Database Supabase

import { supabase } from "@/supabaseClient.js";

const operationInProgress = ref(false);

async function likePostDB() {
  if (operationInProgress.value) return;
  operationInProgress.value = true;

  await loadLikedPosts();

  if (likedPostsIds.value.includes(postId)) {
    operationInProgress.value = false;
    return;
  }

  postLikesCount.value++;

  try {
    const { data, error: selectError } = await supabase
      .from("blogpostslikes")
      .select("likes")
      .eq("post_id", postId);

    if (selectError) {
      throw selectError;
    }

    if (data && data.length > 0) {
      const existingLikes = data[0].likes;
      const { error: updateError } = await supabase
        .from("blogpostslikes")
        .update({ likes: existingLikes + 1 })
        .eq("post_id", postId);
      if (updateError) throw updateError;
      else await toggleLike();
    } else {
      const { error: insertError } = await supabase
        .from("blogpostslikes")
        .insert([{ post_id: postId, likes: 1 }]);

      if (insertError) throw insertError;
    }
  } catch (error) {
    console.error("Error incrementing likes:", error.message);
  } finally {
    operationInProgress.value = false;
  }
}

async function dislikePostDB() {
  if (operationInProgress.value) return;
  operationInProgress.value = true;

  await loadLikedPosts();

  if (!likedPostsIds.value.includes(postId)) {
    operationInProgress.value = false;
    return;
  }
  postLikesCount.value--;

  try {
    const { data: currentData, error: fetchError } = await supabase
      .from("blogpostslikes")
      .select("likes")
      .eq("post_id", postId)
      .single();

    if (fetchError) throw fetchError;

    if (currentData && currentData.likes > 0) {
      const { error: updateError } = await supabase
        .from("blogpostslikes")
        .update({ likes: currentData.likes - 1 })
        .eq("post_id", postId);

      if (updateError) throw updateError;
      else await toggleLike();
    }
  } catch (error) {
    console.error("Error decrementing likes:", error.message);
  } finally {
    operationInProgress.value = false;
  }
}

// Blog posts likes end

// Share page links start

// PASTE SHARE HERE

const shareUrlVK = ref("");
const shareUrlOK = ref("");
const shareUrlTwitter = ref("");
const shareUrlPinterest = ref("");
const shareUrlLinkedIn = ref("");

function prepareSharing() {
  // URL
  const router = useRouter();
  let fullPath = router.currentRoute._value.fullPath;
  const url = encodeURIComponent(fullPath);

  // Title
  const titleString = posts.find((post) => post.id == postId).title;
  const title = encodeURIComponent(titleString);

  // Image
  const imageUrl = encodeURIComponent(
    "https://i.ibb.co/x5bRG7c/Blog-Photo4-Full.webp"
  );

  shareUrlVK.value = `https://vk.com/share.php?url=${url}&title=${title}&image=${imageUrl}&noparse=true`;

  shareUrlOK.value = `https://connect.ok.ru/offer?url=${url}&title=${title}&media=${imageUrl}`;

  shareUrlTwitter.value = `https://twitter.com/intent/tweet?url=${url}&text=${title}&media=${imageUrl}`;

  shareUrlPinterest.value = `https://pinterest.com/pin/create/button/?url=${url}&media=${imageUrl}&description=${title}`;

  shareUrlLinkedIn.value = `https://www.linkedin.com/shareArticle?mini=true&url=${url}&title=${title}&summary=${title}&source=`;
}

// Share page links end
</script>
<style scoped>
@import "@/assets/styles/IndividualArticleStyle.css";
</style>
